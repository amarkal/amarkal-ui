!function(exports){var $=window.jQuery;exports.UI={components:{},registerComponent:function(t,e){Amarkal.UI.components.hasOwnProperty(t)?console.error("Attempting to register an existing component type '"+t+"'"):Amarkal.UI.components[t]=e},getComponentConfig:function(t){if(Amarkal.UI.components.hasOwnProperty(t))return Amarkal.UI.components[t];console.error("A component type '"+t+"' has not been registered")},createComponent:function(t){var e=t.attr("class").match(/amarkal-ui-component-([a-z]+)/)[1],a=Amarkal.UI.getComponentConfig(e),i=$.extend({},Amarkal.UI.abstractComponent,a),n=JSON.parse(t.children(".amarkal-ui-component-props").text());for(var s in i)"function"==typeof i[s]&&(i[s]=i[s].bind(i));return i.constructor(t,n),i},init:function(){$(".amarkal-ui-component").amarkalUIComponent()}},$(document).ready(function(){Amarkal.UI.init()}),Amarkal.UI.abstractComponent={constructor:function(t,e){this.$el=t,this.props=e,this.state={},this.validity=this.VALID,this.setValue(this.props.value)},instance:function(){return this},reset:function(){this.makeValid()},getValue:function(){return this.state.value},setValue:function(){},hasValue:function(){return this.state&&void 0!==this.state.value},getProps:function(){return this.props},setProps:function(t){this.props=Object.assign({},this.props,t)},changed:function(){return this.props.value!==this.state.value},refresh:function(){},setValidity:function(t){var e="amarkal-ui-component-error";t===this.VALID&&this.$el.removeClass(e),t===this.INVALID&&this.$el.addClass(e),this.validity=t},getValidity:function(){return this.validity},getName:function(){return void 0!==this.props.name&&this.props.name},makeInvalid:function(){this.setValidity(this.INVALID)},makeValid:function(){this.setValidity(this.VALID)},onChange:function(){this.$el.trigger("amarkal.change",[this])},show:function(){this.$el.show(),this.refresh(),this.$el.trigger("amarkal.show",[this])},hide:function(){this.$el.hide(),this.$el.trigger("amarkal.hide",[this])},validateType:function(t,e){Amarkal.Core.Utility.validateType(t,e)||console.warn('Amarkal.UI.abstractComponent(...).validateType(...): Expected a value of type "'+e+'" but instead got a "'+typeof t+'" (occurred in component "'+this.props.name+'")')},VALID:"valid",INVALID:"invalid"};function VisibilityManager(t){this.form=t,this.graph=new VisibilityGraph,this.init()}VisibilityManager.prototype.init=function(){this.populateGraph(),this.setInitialVisibility(),this.addOnChangeListeners()},VisibilityManager.prototype.populateGraph=function(){var t=this;this.form.$components.each(function(){var e=$(this).data("amarkal-ui-component").props;if("string"==typeof e.show){t.graph.addNode(e.name);for(var a=/\{\{(\S+)\}\}/g,i=a.exec(e.show);null!==i;)t.graph.addNode(i[1]),t.graph.addEdge(i[1],e.name),i=a.exec(e.show)}})},VisibilityManager.prototype.setInitialVisibility=function(){var t=this;this.graph.getNodes().forEach(function(e){0===t.graph.indegree(e)&&t.visibilityTraversal(e)})},VisibilityManager.prototype.addOnChangeListeners=function(){var t=this;this.graph.getNodes().forEach(function(e){t.graph.outdegree(e)>0&&t.form.getComponent(e).on("amarkal.change",function(a){t.visibilityTraversal(e)})})},VisibilityManager.prototype.visibilityTraversal=function(t){for(var e=this.graph.adjacent(t),a=e.shift();void 0!==a;)this.evaluateCondition(this.form.getComponent(a).amarkalUIComponent("getProps").show)?(this.form.getComponent(a).amarkalUIComponent("show"),e=e.concat(this.graph.adjacent(a))):this.hideNode(a),a=e.shift()},VisibilityManager.prototype.evaluateCondition=function(condition){return eval(this.parseTemplate(condition))},VisibilityManager.prototype.hideNode=function(t){var e=this;this.form.getComponent(t).amarkalUIComponent("hide"),this.graph.adjacent(t).forEach(function(t){e.hideNode(t)})},VisibilityManager.prototype.parseTemplate=function(t){var e=this;return t.replace(/\{\{(\S+)\}\}/g,function(t,a){return JSON.stringify(e.form.getValue(a))})};function VisibilityGraph(){this.nodes=[],this.edges=[]}VisibilityGraph.prototype.addNode=function(t){-1===this.nodes.indexOf(t)&&this.nodes.push(t)},VisibilityGraph.prototype.addEdge=function(t,e){var a={from:t,to:e};0===this.edges.length?this.edges.push(a):this.edgeExists(t,e)||this.edges.push(a)},VisibilityGraph.prototype.edgeExists=function(t,e){return this.edges.some(function(a){return a.from===t&&a.to===e})},VisibilityGraph.prototype.outdegree=function(t){var e=0;return this.edges.forEach(function(a){a.from===t&&(e+=1)}),e},VisibilityGraph.prototype.indegree=function(t){var e=0;return this.edges.forEach(function(a){a.to===t&&(e+=1)}),e},VisibilityGraph.prototype.adjacent=function(t){var e=[];return this.edges.forEach(function(a){a.from===t&&e.push(a.to)}),e},VisibilityGraph.prototype.getNodes=function(){return this.nodes};function Form(t){this.$form=t,this.$components=t.find(".amarkal-ui-component"),this.vm=new VisibilityManager(this);var e=this;$(window).on("beforeunload",function(){if(e.changed())return"Are you sure you want to leave this page?"})}Form.prototype.isVisible=function(t){var e=this.getComponent(t).amarkalUIComponent("getProps");return"string"!=typeof e.show||this.vm.evaluateCondition(e.show)},Form.prototype.refresh=function(){this.$components.each(function(){$(this).amarkalUIComponent("refresh")})},Form.prototype.getComponent=function(t){var e;return this.$components.each(function(){if($(this).amarkalUIComponent("getName")===t)return e=$(this),!1}),e},Form.prototype.changed=function(){var t=!1;return this.$components.each(function(){if($(this).amarkalUIComponent("changed"))return t=!0,!1}),t},Form.prototype.getValue=function(t){return this.getComponent(t).amarkalUIComponent("getValue")},Form.prototype.getData=function(){var t={};return this.$components.each(function(){if(!$(this).parents(".amarkal-ui-component").length&&$(this).amarkalUIComponent("hasValue")){var e=$(this).amarkalUIComponent("getName");t[e]=$(this).amarkalUIComponent("getValue")}}),t},Form.prototype.setData=function(t,e){this.$components.each(function(){if(!$(this).parents(".amarkal-ui-component").length){var a=$(this).amarkalUIComponent("getName");if(void 0===a)return;if(void 0!==e&&e.hasOwnProperty(a))return;t.hasOwnProperty(a)&&$(this).amarkalUIComponent("setValue",t[a])}})},$.fn.extend({amarkalUIComponent:function(t){var e,a,i=arguments.length>1?Array.apply(null,arguments).slice(1):null;return e=this.each(function(){if(!$(this).hasClass("amarkal-ui-component"))throw"This element is not an Amarkal UI component";void 0===$(this).data("amarkal-ui-component")&&$(this).data("amarkal-ui-component",Amarkal.UI.createComponent($(this)));var e=$(this).data("amarkal-ui-component");if(void 0!==t&&e.hasOwnProperty(t)&&void 0!==(a=e[t].apply(e,i)))return!1}),void 0!==a?a:e}}),$.fn.extend({amarkalUIForm:function(t){var e,a,i=arguments.length>1?Array.apply(null,arguments).slice(1):[];$(this[0]).data("amarkal-ui-form");return a=this.each(function(){var a=$(this).data("amarkal-ui-form");if(void 0===a&&(a=new Form($(this)),$(this).data("amarkal-ui-form",a)),void 0!==t&&void 0!==a[t]&&void 0!==(e=a[t].apply(a,i)))return!1}),void 0!==e?e:a}}),Amarkal.UI.registerComponent("button",{constructor:function(t,e){Amarkal.UI.abstractComponent.constructor.call(this,t,e),this._setState("start"),this.props.disabled||this.$el.on("click",this._onClick)},changed:function(){return!1},_doing:!1,_onClick:function(t){t.preventDefault(),this._doing||(this._doing=!0,this._setState("doing"),$.ajax({url:this.props.request_url,data:this._getRequestData(),method:this.props.request_method,success:this._onDone,error:this._onError}))},_getRequestData:function(){var t=Object.assign({},this.props.request_data),e=this.$el.closest("form").amarkalUIForm("getData"),a=function(t,a,i){return e[i.trim()]};for(var i in t)t[i]=t[i].replace(/(\{\{([\w\d-]*)\}\})/g,a);return t},_onDone:function(t){var e=this;this._setState("done"),setTimeout(function(){e._setState("start"),e._doing=!1},3e3)},_onError:function(){var t=this;this._setState("error"),setTimeout(function(){t._setState("start"),t._doing=!1},3e3)},_setState:function(t){this.$el.find("button").text(this.props["label_"+t]).attr("class","").addClass("amarkal-ui-"+t)}}),Amarkal.UI.registerComponent("checkbox",{constructor:function(t,e){Amarkal.UI.abstractComponent.constructor.call(this,t,e);var a=this;this.$el.find("input").on("change",function(t){var e=t.target.value,i=a.state.value.slice(),n=i.indexOf(e);-1===n?i.push(e):i.splice(n,1),a.setValue(i)})},setValue:function(t){if(this.validateType(t,"array"),!Amarkal.Core.Array.same(this.state.value,t)){if(this.state.value=t,this.$el.find("input").attr("checked",!1),t.length)for(var e=0;e<t.length;e++)this.$el.find('input[value="'+t[e]+'"]').attr("checked",!0);this.onChange()}},changed:function(){return!Amarkal.Core.Array.same(this.state.value,this.props.value)}}),Amarkal.UI.registerComponent("code",{editor:null,constructor:function(t,e){var a=this,i=t.find(".amarkal-ui-component-ace-editor");ace.config.set("basePath","https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.8/"),this.editor=ace.edit(i[0]),this.editor.getSession().setUseWorker(!1),this.editor.setTheme("ace/theme/"+e.theme),this.editor.getSession().setMode("ace/mode/"+e.language),this.editor.setReadOnly(e.readonly||e.disabled),this.editor.$blockScrolling=1/0,this.editor.setOptions({maxLines:e.max_lines}),Amarkal.UI.abstractComponent.constructor.call(this,t,e),i.on("keyup",function(){a.setValue(a.editor.getValue())})},setValue:function(t){this.state.value!==t&&(this.validateType(t,"string"),this.state.value=t,this.$el.children("textarea").val(t),this.editor.setValue(t),this.editor.navigateLineEnd(),this.onChange())},refresh:function(){this.editor.resize(),this.editor.renderer.updateFull()}}),Amarkal.UI.registerComponent("composite",{constructor:function(t,e){Amarkal.UI.abstractComponent.constructor.call(this,t,e);var a=this;this.$el.find(".amarkal-ui-component").on("amarkal.change",function(){var t=$(this).amarkalUIComponent("getName"),e=$(this).amarkalUIComponent("getValue"),i=Object.assign({},a.state.value);i[t]=e,a.setValue(i)})},setValue:function(t){if(!Amarkal.Core.Object.equal(this.state.value,t)){this.validateType(t,"object"),this.state.value=t;for(var e in t)this.$el.find('[amarkal-component-name="'+e+'"]').amarkalUIComponent("setValue",t[e]);this.onChange()}},changed:function(){return!Amarkal.Core.Object.equal(this.state.value,this.props.value)}}),Amarkal.UI.registerComponent("html",{changed:function(){return!1}}),Amarkal.UI.registerComponent("number",{constructor:function(t,e){Amarkal.UI.abstractComponent.constructor.call(this,t,e);var a=this;this.$el.find("input").on("change",function(t){a.setValue(Number(t.target.value))})},setValue:function(t){t!==this.state.value&&(this.validateType(t,"number"),this.state.value=t,this.$el.find("input").val(t),this.onChange())}}),Amarkal.UI.registerComponent("progressbar",{constructor:function(t,e){Amarkal.UI.abstractComponent.constructor.call(this,t,$.extend({},e,{delta:Math.abs(e.max-e.min),labelWidth:30,minSpacing:50})),this._updateLabel(),this._populateValueLabels(),$(window).on("resize",this.refresh)},setValue:function(t){this.props.value=t,this.refresh()},getValue:function(){return this.props.value},refresh:function(){this._updateLabel(),this._populateValueLabels()},changed:function(){return!1},_updateLabel:function(){var t=100*(this.props.value-this.props.min)/this.props.delta;this.$el.find(".amarkal-ui-progressbar-inner").css({width:t+"%"}),this.$el.find(".amarkal-ui-value-label").text(this.getValue()).css({left:t+"%"})},_populateValueLabels:function(){var t=this.$el.find(".amarkal-ui-progressbar"),e=this.$el.find(".amarkal-ui-progressbar-values"),a=this._formatNumber,i=this.props,n=i.labelWidth,s=i.minSpacing,o=(this.getValue(),t.width()),r=Math.floor(Math.min((o+s)/(n+s),i.delta+1));e.html(function(){for(var t="",e=0;e<r;e++){var n=i.delta/(r-1)*e+i.min;t+="<span>"+a(n)+"</span>"}return t}())},_formatNumber:function(t){var e=this.props.delta,a=this.props.step;return e/1e6>1?(t/1e6).toFixed(1).replace(/\.0$/,"")+"M":e/1e3>1?(t/1e3).toFixed(1).replace(/\.0$/,"")+"K":a<1?t.toFixed(1).replace(/\.0$/,""):Math.round(t)}}),Amarkal.UI.registerComponent("radio",{constructor:function(t,e){Amarkal.UI.abstractComponent.constructor.call(this,t,e);var a=this;this.$el.find("input").on("change",function(t){a.setValue(t.target.value)})},setValue:function(t){t!==this.state.value&&(this.validateType(t,"string"),this.state.value=t,this.$el.find("input").attr("checked",!1),this.$el.find('input[value="'+t+'"]').attr("checked",!0),this.onChange())}}),Amarkal.UI.registerComponent("select",{constructor:function(t,e){Amarkal.UI.abstractComponent.constructor.call(this,t,e);var a=this;this.$el.find("select").on("change",function(t){a.setValue(t.target.value)})},setValue:function(t){t!==this.state.value&&(this.validateType(t,"string"),this.state.value=t,this.$el.find("select > option").attr("selected",!1),this.$el.find('select > option[value="'+t+'"]').attr("selected",!0),this.onChange())}}),Amarkal.UI.registerComponent("slider",{constructor:function(t,e){Amarkal.UI.abstractComponent.constructor.call(this,t,e);var a=this,i=this.$el.find("input");this.$el.find(".slider-value-label");this._setProps(),this._updateLabelPosition(),this._populateValueLabels(),this._updateLabelValue(i.val()),i.on("input change",function(){a._updateLabelValue(i.val()),a._updateLabelPosition(),a.setValue(Number(i.val()))}),$(window).on("resize",this.refresh)},setValue:function(t){t!==this.state.value&&(this.validateType(t,"number"),this.state.value=t,this.$el.find("input").val(t),this._updateLabelPosition(),this._updateLabelValue(t),this.onChange())},refresh:function(){this._updateLabelPosition(),this._populateValueLabels()},_setProps:function(){this.props=$.extend({},this.props,{delta:Math.abs(this.props.max-this.props.min),knobWidth:26,labelWidth:30,minSpacing:50})},_updateLabelPosition:function(){var t=this.$el.find("input"),e=this.props,a=t.val(),i=t.width(),n=e.knobWidth/2+(i-e.knobWidth)*(a-e.min)/e.delta;this.$el.find(".slider-value-label").css({left:n+"px"})},_updateLabelValue:function(t){this.$el.find(".slider-value-label").text(t)},_populateValueLabels:function(){var t=this.$el.find("input"),e=this.$el.find(".slider-values"),a=this._formatNumber,i=this.props,n=i.labelWidth,s=i.minSpacing,o=(t.val(),t.width()),r=Math.floor(Math.min((o+s)/(n+s),i.delta/i.step+1));e.html(function(){for(var t="",e=0;e<r;e++){var n=i.delta/(r-1)*e+i.min;t+="<span>"+a(n)+"</span>"}return t}())},_formatNumber:function(t){var e=this.props.delta,a=this.props.step;return e/1e6>1?(t/1e6).toFixed(1).replace(/\.0$/,"")+"M":e/1e3>1?(t/1e3).toFixed(1).replace(/\.0$/,"")+"K":a<1?t.toFixed(1).replace(/\.0$/,""):Math.round(t)}}),Amarkal.UI.registerComponent("switch",{constructor:function(t,e){Amarkal.UI.abstractComponent.constructor.call(this,t,e);var a=this;this.$el.find('input[type="checkbox"]').on("change",function(t){a.setValue(t.target.checked?"on":"off")})},setValue:function(t){t!==this.state.value&&(this.validateType(t,"string"),this.state.value=t,this.$el.find('input[type="hidden"]').val(t),this.$el.find('input[type="checkbox"]').attr("checked","on"===t),this.onChange())}}),Amarkal.UI.registerComponent("text",{constructor:function(t,e){Amarkal.UI.abstractComponent.constructor.call(this,t,e);var a=this;this.$el.find("input").on("keyup",function(t){a.setValue(t.target.value)})},setValue:function(t){t!==this.state.value&&(this.validateType(t,"string"),this.state.value=t,this.$el.find("input").val(t),this.onChange())}}),Amarkal.UI.registerComponent("textarea",{constructor:function(t,e){Amarkal.UI.abstractComponent.constructor.call(this,t,e);var a=this;this.$el.find("textarea").on("keyup",function(t){a.setValue(t.target.value)})},setValue:function(t){t!==this.state.value&&(this.validateType(t,"string"),this.state.value=t,this.$el.find("textarea").val(t),this.onChange())}}),Amarkal.UI.registerComponent("toggle",{constructor:function(t,e){Amarkal.UI.abstractComponent.constructor.call(this,t,e);var a=this;this.props.disabled||this.$el.find(".amarkal-ui-toggle-labels div").on("click",function(){a._onClick($(this))})},setValue:function(t){this.props.multi?Amarkal.Core.Array.same(t,this.state.value)||(this.validateType(t,"array"),this.state.value=t,this.$el.find("input").val(t.join(",")),this._setActiveValues(t),this.onChange()):t!==this.state.value&&(this.validateType(t,"string"),this.state.value=t,this.$el.find("input").val(t),this._setActiveValues(t),this.onChange())},changed:function(){return this.props.multi?!Amarkal.Core.Array.same(this.state.value,this.props.value):this.state.value!==this.props.value},_onClick:function(t){var e;this.getValue();this.props.multi?(t.toggleClass("active"),e=this._getActiveValues()):(t.siblings().removeClass("active"),t.addClass("active"),e=t.attr("data-value")),this.setValue(e)},_getActiveValues:function(){var t=[];return this.$el.find(".amarkal-ui-toggle-labels div.active").each(function(){t.push($(this).attr("data-value"))}),t},_setActiveValues:function(t){var e=this.props.multi;this.$el.find(".amarkal-ui-toggle-labels div").each(function(){var a=$(this).attr("data-value");$(this).removeClass("active"),(e&&t.indexOf(a)>-1||!e&&t===a)&&$(this).addClass("active")})}})}("undefined"==typeof Amarkal?Amarkal={}:Amarkal);
//# sourceMappingURL=amarkal-ui.min.js.map