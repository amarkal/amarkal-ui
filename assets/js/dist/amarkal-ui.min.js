!function(exports){function VisibilityManager(t){this.form=t,this.graph=new VisibilityGraph,this.init()}function VisibilityGraph(){this.nodes=[],this.edges=[]}var $=window.jQuery;exports.UI={components:{},registerComponent:function(t,e){Amarkal.UI.components.hasOwnProperty(t)?console.error("Attempting to register an existing component type '"+t+"'"):Amarkal.UI.components[t]=e},getComponentConfig:function(t){if(Amarkal.UI.components.hasOwnProperty(t))return Amarkal.UI.components[t];console.error("A component type '"+t+"' has not been registered")},createComponent:function(t){var e=t.attr("class").match(/amarkal-ui-component-([a-z]+)/)[1],i=Amarkal.UI.getComponentConfig(e),n=$.extend({},Amarkal.UI.abstractComponent,i);n.$el=t,n.props=JSON.parse(t.children(".amarkal-ui-component-props").text());for(var a in n)"function"==typeof n[a]&&(n[a]=n[a].bind(n));return n.onInit(),n},init:function(){$(".amarkal-ui-component").amarkalUIComponent()}},$(document).ready(function(){Amarkal.UI.init()}),Amarkal.UI.abstractComponent={$el:null,props:{},validity:null,instance:function(){return this},reset:function(){this.makeValid()},getValue:function(){return null},setValue:function(){},getProps:function(){return this.props},setProps:function(t){this.props=Object.assign({},this.props,t)},refresh:function(){},setValidity:function(t){t===this.VALID&&this.$el.removeClass("amarkal-ui-component-error"),t===this.INVALID&&this.$el.addClass("amarkal-ui-component-error"),this.validity=t},getValidity:function(){return this.validity},getName:function(){return this.props.name},makeInvalid:function(){this.setValidity(this.INVALID)},makeValid:function(){this.setValidity(this.VALID)},onInit:function(){},onChange:function(){this.$el.trigger("amarkal.change",[this])},show:function(){this.$el.show(),this.refresh(),this.$el.trigger("amarkal.show",[this])},hide:function(){this.$el.hide(),this.$el.trigger("amarkal.hide",[this])},VALID:"valid",INVALID:"invalid"},VisibilityManager.prototype.init=function(){this.populateGraph(),this.setInitialVisibility(),this.addOnChangeListeners()},VisibilityManager.prototype.populateGraph=function(){var t=this;this.form.$components.each(function(){var e=$(this).data("amarkal-ui-component").props;if("string"==typeof e.show){t.graph.addNode(e.name);for(var i=/\{\{(\S+)\}\}/g,n=i.exec(e.show);null!==n;)t.graph.addNode(n[1]),t.graph.addEdge(n[1],e.name),n=i.exec(e.show)}})},VisibilityManager.prototype.setInitialVisibility=function(){var t=this;this.graph.getNodes().forEach(function(e){0===t.graph.indegree(e)&&t.visibilityTraversal(e)})},VisibilityManager.prototype.addOnChangeListeners=function(){var t=this;this.graph.getNodes().forEach(function(e){t.graph.outdegree(e)>0&&t.form.getComponent(e).on("amarkal.change",function(i){t.visibilityTraversal(e)})})},VisibilityManager.prototype.visibilityTraversal=function(t){for(var e=this.graph.adjacent(t),i=e.shift();void 0!==i;)this.evaluateCondition(this.form.getComponent(i).amarkalUIComponent("getProps").show)?(this.form.getComponent(i).amarkalUIComponent("show"),e=e.concat(this.graph.adjacent(i))):this.hideNode(i),i=e.shift()},VisibilityManager.prototype.evaluateCondition=function(condition){return eval(this.parseTemplate(condition))},VisibilityManager.prototype.hideNode=function(t){var e=this;this.form.getComponent(t).amarkalUIComponent("hide"),this.graph.adjacent(t).forEach(function(t){e.hideNode(t)})},VisibilityManager.prototype.parseTemplate=function(t){var e=this;return t.replace(/\{\{(\S+)\}\}/g,function(t,i){return JSON.stringify(e.form.getValue(i))})},VisibilityGraph.prototype.addNode=function(t){-1===this.nodes.indexOf(t)&&this.nodes.push(t)},VisibilityGraph.prototype.addEdge=function(t,e){var i={from:t,to:e};0===this.edges.length?this.edges.push(i):this.edgeExists(t,e)||this.edges.push(i)},VisibilityGraph.prototype.edgeExists=function(t,e){return this.edges.some(function(i){return i.from===t&&i.to===e})},VisibilityGraph.prototype.outdegree=function(t){var e=0;return this.edges.forEach(function(i){i.from===t&&(e+=1)}),e},VisibilityGraph.prototype.indegree=function(t){var e=0;return this.edges.forEach(function(i){i.to===t&&(e+=1)}),e},VisibilityGraph.prototype.adjacent=function(t){var e=[];return this.edges.forEach(function(i){i.from===t&&e.push(i.to)}),e},VisibilityGraph.prototype.getNodes=function(){return this.nodes},Amarkal.UI.form=function(t){this.$form=t,this.$components=t.find(".amarkal-ui-component"),this.vm=new VisibilityManager(this)},Amarkal.UI.form.prototype.isVisible=function(t){var e=this.getComponent(t).amarkalUIComponent("getProps");return"string"!=typeof e.show||this.vm.evaluateCondition(e.show)},Amarkal.UI.form.prototype.refresh=function(){this.$components.each(function(){$(this).amarkalUIComponent("refresh")})},Amarkal.UI.form.prototype.getComponent=function(t){var e;return this.$components.each(function(){if($(this).amarkalUIComponent("getName")===t)return e=$(this),!1}),e},Amarkal.UI.form.prototype.getValue=function(t){return this.getComponent(t).amarkalUIComponent("getValue")},Amarkal.UI.form.prototype.getData=function(){var t={};return this.$components.each(function(){if(!$(this).parents(".amarkal-ui-component").length){var e=$(this).amarkalUIComponent("getName"),i=$(this).amarkalUIComponent("getValue");void 0!==e&&(t[e]=i)}}),t},Amarkal.UI.form.prototype.setData=function(t,e){this.$components.each(function(){if(!$(this).parents(".amarkal-ui-component").length){var i=$(this).amarkalUIComponent("getName");if(void 0===i)return;if(void 0!==e&&e.hasOwnProperty(i))return;t.hasOwnProperty(i)&&$(this).amarkalUIComponent("setValue",t[i])}})},$.fn.extend({amarkalUIComponent:function(t){var e,i,n=arguments.length>1?Array.apply(null,arguments).slice(1):null;return e=this.each(function(){if(!$(this).hasClass("amarkal-ui-component"))throw"This element is not an Amarkal UI component";void 0===$(this).data("amarkal-ui-component")&&$(this).data("amarkal-ui-component",Amarkal.UI.createComponent($(this)));var e=$(this).data("amarkal-ui-component");if(void 0!==t&&e.hasOwnProperty(t)&&void 0!==(i=e[t].apply(e,n)))return!1}),void 0!==i?i:e}}),$.fn.extend({amarkalUIForm:function(t){var e=arguments.length>1?Array.apply(null,arguments).slice(1):[],i={},n=$(this[0]);void 0===n.data("amarkal-ui-form")&&n.data("amarkal-ui-form",new Amarkal.UI.form(n));var a=n.data("amarkal-ui-form");return void 0!==t&&void 0!==a[t]&&(i=a[t].apply(a,e)),i}}),Amarkal.UI.registerComponent("button",{onInit:function(){this._setState("start"),this.props.disabled||this.$el.on("click",this._onClick)},_doing:!1,_onClick:function(t){t.preventDefault(),this._doing||(this._doing=!0,this._setState("doing"),$.ajax({url:this.props.request_url,data:this._getRequestData(),method:this.props.request_method,success:this._onDone,error:this._onError}))},_getRequestData:function(){var t=Object.assign({},this.props.request_data),e=this.$el.closest("form").amarkalUIForm("getData");for(key in t)t[key]=t[key].replace(/(\{\{([\w\d-]*)\}\})/g,function(t,i,n){return e[n.trim()]});return t},_onDone:function(t){var e=this;this._setState("done"),setTimeout(function(){e._setState("start"),e._doing=!1},3e3)},_onError:function(){var t=this;this._setState("error"),setTimeout(function(){t._setState("start"),t._doing=!1},3e3)},_setState:function(t){this.$el.find("button").text(this.props["label_"+t]).attr("class","").addClass("amarkal-ui-"+t)}}),Amarkal.UI.registerComponent("checkbox",{setValue:function(t){if(this.$el.find("input").attr("checked",!1),t.length)for(var e=0;e<t.length;e++)this.$el.find('input[value="'+t[e]+'"]').attr("checked",!0)},getValue:function(){return this.$el.find("input:checked").toArray().map(function(t){return t.value})},onInit:function(){var t=this;this.$el.find("input").on("change",function(){t.onChange()})}}),Amarkal.UI.registerComponent("code",{editor:null,setValue:function(t){this.editor.setValue(t),this.editor.navigateLineEnd(),this.$el.children("textarea").val(t)},getValue:function(){return this.editor.getValue()},onInit:function(){var t=this,e=this.$el.find(".amarkal-ui-component-ace-editor");ace.config.set("basePath","https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.8/"),this.editor=ace.edit(e[0]),this.editor.getSession().setUseWorker(!1),this.editor.setTheme("ace/theme/"+this.props.theme),this.editor.getSession().setMode("ace/mode/"+this.props.language),this.editor.setOptions({maxLines:this.props.max_lines}),this.editor.setReadOnly(this.props.readonly||this.props.disabled),this.setValue(this.props.value),e.on("keyup",function(){t.$el.children("textarea").val(t.editor.getValue()),t.onChange()})},refresh:function(){this.editor.resize(),this.editor.renderer.updateFull()}}),Amarkal.UI.registerComponent("composite",{setValue:function(t){for(var e in t)this.$el.find('[amarkal-component-name="'+e+'"]').amarkalUIComponent("setValue",t[e])},getValue:function(){var t={};return this.$el.find(".amarkal-ui-component").each(function(){var e=$(this).attr("amarkal-component-name");$(this).amarkalUIComponent(),t[e]=$(this).amarkalUIComponent("getValue")}),t},onInit:function(){var t=this;this.$el.find(".amarkal-ui-component").on("amarkal.change",function(){t.onChange()})}}),Amarkal.UI.registerComponent("html",{}),Amarkal.UI.registerComponent("number",{setValue:function(t){this.$el.find("input").val(t)},getValue:function(){return this.$el.find("input").val()},onInit:function(){var t=this;this.$el.find("input").on("change",function(){t.onChange()})}}),Amarkal.UI.registerComponent("progressbar",{setValue:function(t){this.props.value=t,this.refresh()},getValue:function(){return this.props.value},onInit:function(){this.$el.find(".amarkal-ui-value-label");this._setProps(),this._updateLabel(),this._populateValueLabels(),$(window).on("resize",this.refresh)},refresh:function(){this._updateLabel(),this._populateValueLabels()},_setProps:function(){this.props=$.extend({},this.props,{delta:Math.abs(this.props.max-this.props.min),labelWidth:30,minSpacing:50})},_updateLabel:function(){var t=100*(this.props.value-this.props.min)/this.props.delta;this.$el.find(".amarkal-ui-progressbar-inner").css({width:t+"%"}),this.$el.find(".amarkal-ui-value-label").text(this.getValue()).css({left:t+"%"})},_populateValueLabels:function(){var t=this.$el.find(".amarkal-ui-progressbar"),e=this.$el.find(".amarkal-ui-progressbar-values"),i=this._formatNumber,n=this.props,a=n.labelWidth,o=n.minSpacing,r=(this.getValue(),t.width()),s=Math.floor(Math.min((r+o)/(a+o),n.delta+1));e.html(function(){for(var t="",e=0;e<s;e++){var a=n.delta/(s-1)*e+n.min;t+="<span>"+i(a)+"</span>"}return t}())},_formatNumber:function(t){var e=this.props.delta,i=this.props.step;return e/1e6>1?(t/1e6).toFixed(1).replace(/\.0$/,"")+"M":e/1e3>1?(t/1e3).toFixed(1).replace(/\.0$/,"")+"K":i<1?t.toFixed(1).replace(/\.0$/,""):Math.round(t)}}),Amarkal.UI.registerComponent("radio",{setValue:function(t){this.$el.find("input").attr("checked",!1),this.$el.find('input[value="'+t+'"]').attr("checked",!0)},getValue:function(){return this.$el.find("input:checked").val()},onInit:function(){var t=this;this.$el.find("input").on("change",function(){t.onChange()})}}),Amarkal.UI.registerComponent("select",{setValue:function(t){this.$el.find("select > option").attr("selected",!1),this.$el.find('select > option[value="'+t+'"]').attr("selected",!0)},getValue:function(){return this.$el.find("select").val()},onInit:function(){var t=this;this.$el.find("select").on("change",function(){t.onChange()})}}),Amarkal.UI.registerComponent("slider",{setValue:function(t){this.$el.find("input").val(t),this._updateLabelPosition(),this._updateLabelValue(t)},getValue:function(){return this.$el.find("input").val()},onInit:function(){var t=this,e=this.$el.find("input");this.$el.find(".slider-value-label");this._setProps(),this._updateLabelPosition(),this._populateValueLabels(),this._updateLabelValue(e.val()),e.on("input change",function(){t._updateLabelValue(e.val()),t._updateLabelPosition(),t.onChange()}),$(window).on("resize",this.refresh)},refresh:function(){this._updateLabelPosition(),this._populateValueLabels()},_setProps:function(){this.props=$.extend({},this.props,{delta:Math.abs(this.props.max-this.props.min),knobWidth:26,labelWidth:30,minSpacing:50})},_updateLabelPosition:function(){var t=this.$el.find("input"),e=this.props,i=t.val(),n=t.width(),a=e.knobWidth/2+(n-e.knobWidth)*(i-e.min)/e.delta;this.$el.find(".slider-value-label").css({left:a+"px"})},_updateLabelValue:function(t){this.$el.find(".slider-value-label").text(t)},_populateValueLabels:function(){var t=this.$el.find("input"),e=this.$el.find(".slider-values"),i=this._formatNumber,n=this.props,a=n.labelWidth,o=n.minSpacing,r=(t.val(),t.width()),s=Math.floor(Math.min((r+o)/(a+o),n.delta/n.step+1));e.html(function(){for(var t="",e=0;e<s;e++){var a=n.delta/(s-1)*e+n.min;t+="<span>"+i(a)+"</span>"}return t}())},_formatNumber:function(t){var e=this.props.delta,i=this.props.step;return e/1e6>1?(t/1e6).toFixed(1).replace(/\.0$/,"")+"M":e/1e3>1?(t/1e3).toFixed(1).replace(/\.0$/,"")+"K":i<1?t.toFixed(1).replace(/\.0$/,""):Math.round(t)}}),Amarkal.UI.registerComponent("switch",{setValue:function(t){this.$el.find('input[type="hidden"]').val(t),"on"===t?this.$el.find('input[type="checkbox"]').attr("checked",!0):this.$el.find('input[type="checkbox"]').attr("checked",!1)},getValue:function(){return this.$el.find('input[type="hidden"]').val()},onInit:function(){var t=this;this.$el.find('input[type="checkbox"]').on("change",function(e){t.$el.find('input[type="hidden"]').val(e.target.checked?"on":"off"),t.onChange()})}}),Amarkal.UI.registerComponent("text",{setValue:function(t){this.$el.find("input").val(t)},getValue:function(){return this.$el.find("input").val()},onInit:function(){var t=this;this.$el.find("input").on("keyup",function(){t.onChange()})}}),Amarkal.UI.registerComponent("textarea",{setValue:function(t){this.$el.find("textarea").val(t)},getValue:function(){return this.$el.find("textarea").val()},onInit:function(){var t=this;this.$el.find("textarea").on("keyup",function(){t.onChange()})}}),Amarkal.UI.registerComponent("toggle",{setValue:function(t){this.props.multi?this.$el.find("input").val(t.join(",")):this.$el.find("input").val(t),this._setActiveValues(t)},getValue:function(){var t=this.$el.find("input").val();return this.props.multi?t.split(","):t},onInit:function(){var t=this;this.props.disabled||this.$el.find(".amarkal-ui-toggle-labels div").on("click",function(){t._onClick($(this))})},_onClick:function(t){var e;this.getValue();this.props.multi?(t.toggleClass("active"),e=this._getActiveValues()):(t.siblings().removeClass("active"),t.addClass("active"),e=t.attr("data-value")),this.setValue(e),this.onChange()},_getActiveValues:function(){var t=[];return this.$el.find(".amarkal-ui-toggle-labels div.active").each(function(){t.push($(this).attr("data-value"))}),t},_setActiveValues:function(t){var e=this.props.multi;this.$el.find(".amarkal-ui-toggle-labels div").each(function(){var i=$(this).attr("data-value");$(this).removeClass("active"),(e&&t.indexOf(i)>-1||!e&&t===i)&&$(this).addClass("active")})}})}("undefined"==typeof Amarkal?Amarkal={}:Amarkal);
//# sourceMappingURL=amarkal-ui.min.js.map